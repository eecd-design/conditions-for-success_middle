---
import { ClientRouter } from "astro:transitions";

import Header from "../components/Header.astro";

import "../styles/normalize.css";
import "../styles/global.css";

import { Image } from "astro:assets";
import GNBLogo from "../images/gnb-logo-reverse.png";

let path = Astro.url.pathname;

const { pageTitle, indicatorTag, pageType } = Astro.props;
---

<!doctype html>
<html lang="en" data-loading>
	<head>
		<!-- Set relative path root to '/conditions-for-success/' -->
		<base href={Astro.url.origin + import.meta.env.BASE_URL} />

		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<meta name="generator" content={Astro.generator} />
		<!-- <meta name="color-scheme" content="dark light" /> -->
		<title>{pageTitle}</title>

		<!-- Progressive Enhancement Handlers (not for view transition) -->
		<script is:inline>
			let html = document.documentElement;
			html.dataset.js = "";
		</script>

		<!-- Public Sans Font ~ Google Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,100..900;1,100..900"
			rel="stylesheet"
		/>
		<!-- Aesthet Nova Font ~ Adobe Fonts -->
		<link rel="stylesheet" href="https://use.typekit.net/omy5wmz.css" />

		<ClientRouter />
	</head>
	<body>
		<div
			class="skip-link-container"
			data-theme="red"
			data-background="dark"
		>
			<a href={`${path}#main-heading`} class="skip-link"
				>Skip to main content</a
			>
		</div>
		<Header />
		<main
			class:list={[pageType]}
			data-mode="reading"
			data-indicator-tag={indicatorTag ? indicatorTag : null}
		>
			<div class="wrapper">
				<div class="toast-group">
					<slot name="toast-group" />
				</div>
				<slot />
			</div>
		</main>
		<footer>
			<div class="wrapper">
				<div class="content-container">
					<div class="contact-container">
						<h2 data-font-type="sans-serif">Contact</h2>
						<small>Beth Henderson</small>
						<small>Middle Level Learning Project Lead</small>
						<small
							><a href="mailto:beth.henderson@gnb.ca"
								>beth.henderson@gnb.ca</a
							></small
						>
					</div>
					<div class="separator"></div>
					<small
						>NB Middle School Developmental Continuums v<span
							data-field="continuumVersion"></span></small
					>
				</div>
				<div class="content-container">
					<div class="copyright-container">
						<Image
							src={GNBLogo}
							alt="Government of New Brunswick Logo"
						/>
						<small class="copyright"
							>Copyright Â© <span id="copyrightYear">2025</span> Government
							of New Brunswick. All Rights Reserved.</small
						>
					</div>
				</div>
			</div>
		</footer>
	</body><script>
		//
		// Imports
		//

		import {
			getActiveAssessmentData,
			setState,
			subscribe,
		} from "src/stores/userDataStore";
		import { scrollIntoView } from "src/utilities/helpers";
		import { dialogControl } from "src/utilities/dialog";
		import { scrollControl } from "src/utilities/scroll";
		import { eventControl } from "src/utilities/event";
		import { results, search } from "src/utilities/list";

		//
		// DOM Updates
		//

		let updateCopyright = () => {
			let field = document.querySelector("#copyrightYear");
			if (field) field.textContent = String(new Date().getFullYear());
		};
		updateCopyright();

		let updateContinuumVersion = (data: UserData, changes) => {
			let triggerKeys = ["currentContinuumVersion"];
			if (
				!changes.initiating &&
				!(
					changes.uiState &&
					triggerKeys.some((val) => changes.uiState.includes(val))
				)
			)
				return;

			// console.log("Updating Continuum Version (footer)");

			let continuumVersion = data.uiState.currentContinuumVersion;

			// 1. Site footer
			let fields = document.querySelectorAll(
				`[data-field="continuumVersion"]`,
			);
			for (let field of fields) {
				field.textContent = continuumVersion;
			}
		};

		let updateTheme = (data: UserData, changes) => {
			let triggerKeys = ["theme"];
			if (
				!changes.initiating &&
				!(
					changes.uiPreferences &&
					triggerKeys.some((val) =>
						changes.uiPreferences.includes(val),
					)
				)
			)
				return;

			let theme = data.uiPreferences.theme;
			if (theme !== "dark" && theme !== "light") return;

			// console.log("Updating Theme (on html)");

			// Get the html root
			let html = document.documentElement;

			// Update the theme
			html.setAttribute("data-theme", theme);
		};

		let updateMode = (data: UserData, changes) => {
			let triggerKeys = ["mode"];
			if (
				!changes.initiating &&
				!(
					changes.uiState &&
					triggerKeys.some((val) => changes.uiState.includes(val))
				)
			)
				return;

			let mode = data.uiState.mode;
			if (mode !== "assessment" && mode !== "reading") mode = "reading";

			// console.log("Updating Mode (on main)");

			// Get the main
			let main = document.querySelector("main");

			// Update the mode
			main.setAttribute("data-mode", mode);
		};

		let updateStatus = (data: UserData, changes) => {
			let stateTriggerKeys = ["activeAssessmentId"];
			let assessmentTriggerKeys = ["status"];
			if (
				!changes.initiating &&
				!(
					(changes.assessments &&
						assessmentTriggerKeys.some((val) =>
							changes.assessments.includes(val),
						)) ||
					(changes.uiState &&
						stateTriggerKeys.some((val) =>
							changes.uiState.includes(val),
						))
				)
			)
				return;

			let assessment = getActiveAssessmentData();
			if (!assessment) return;

			// console.log("Updating Status (on main)");

			let status = assessment.status;
			if (status !== "In Progress" && status !== "Complete")
				status = "In Progress";

			// Get the main
			let main = document.querySelector("main");

			// Update the status
			main.setAttribute(
				"data-status",
				status.split(" ").join("-").toLowerCase(),
			);
		};

		let updateAssessor = (data: UserData, changes) => {
			let stateTriggerKeys = ["activeAssessmentId"];
			let assessmentTriggerKeys = ["activeAssessor"];
			if (
				!changes.initiating &&
				!(
					(changes.assessments &&
						assessmentTriggerKeys.some((val) =>
							changes.assessments.includes(val),
						)) ||
					(changes.uiState &&
						stateTriggerKeys.some((val) =>
							changes.uiState.includes(val),
						))
				)
			)
				return;

			let assessment = getActiveAssessmentData();
			if (!assessment) return;

			// console.log("Updating Assessor (on main)");

			// Get the main
			let main = document.querySelector("main");

			// Update the assessor
			if (
				!assessment.activeAssessor ||
				assessment.activeAssessor === undefined
			) {
				main.setAttribute("data-assessor", "false");
			} else {
				main.setAttribute("data-assessor", "true");
			}
		};

		//
		// Methods
		//

		//
		// Inits
		//

		subscribe(updateContinuumVersion);
		subscribe(updateTheme);
		subscribe(updateMode);
		subscribe(updateStatus);
		subscribe(updateAssessor);

		dialogControl.init();
		eventControl.add({
			elem: document,
			eventType: "astro:after-swap",
			fn: dialogControl.init,
		});

		search.init();
		eventControl.add({
			elem: document,
			eventType: "astro:after-swap",
			fn: search.init,
		});

		results.init();
		eventControl.add({
			elem: document,
			eventType: "astro:after-swap",
			fn: results.init,
		});

		scrollControl.init();

		//
		// Event listeners
		//

		let onPageLoad = () => {
			// Store last visited page
			let path = window.location.pathname;
			let base = "/conditions-for-success/";

			if (!path.endsWith(base)) {
				setState({
					lastVisitedPage: {
						title: document.title,
						path,
					},
				});
			}

			// Handle search queries
			let query = new URLSearchParams(window.location.search);
			console.log("Query: ", query);
			let dialog = query.get("dialog");
			if (dialog) {
				let dialogId;
				if (dialog === "create-assessment")
					dialogId = "edit-assessment-properties-dialog";
				if (!dialogId) return;
				dialogControl.open({
					dialogId,
					context: "setup",
				});
				history.replaceState({}, "", window.location.pathname);
			}

			// After delay, clear loading state
			setTimeout(() => {
				document.documentElement.removeAttribute("data-loading");
			}, 1000);
		};
		eventControl.add({
			elem: document,
			eventType: "astro:page-load",
			fn: onPageLoad,
		});

		let onBeforeSwap = (event) => {
			let newDocument = event.newDocument.documentElement;
			console.log("Before Swap: Incoming Document: ", newDocument);
			newDocument.dataset.js = "";
			newDocument.dataset.loading = "";
			// if ("scrollRestoration" in history) {
			// 	let prev = history.scrollRestoration;
			// 	history.scrollRestoration = "manual";
			// 	window.scrollTo(0, 0);
			// 	history.scrollRestoration = prev;
			// }
		};
		eventControl.add({
			elem: document,
			eventType: "astro:before-swap",
			fn: onBeforeSwap,
		});

		console.log(eventControl._registry);
	</script>
</html>
