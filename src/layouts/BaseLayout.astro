---
import { ClientRouter } from "astro:transitions";

import Header from "../components/Header.astro";

import "../styles/normalize.css";
import "../styles/global.css";

const { pageTitle, indicatorTag } = Astro.props;
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<meta name="generator" content={Astro.generator} />
		<!-- <meta name="color-scheme" content="dark light" /> -->
		<title>{pageTitle}</title>
		<!-- Public Sans Font ~ Google Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,100..900;1,100..900"
			rel="stylesheet"
		/>
		<!-- Aesthet Nova Font ~ Adobe Fonts -->
		<link rel="stylesheet" href="https://use.typekit.net/omy5wmz.css" />
		<ClientRouter />
	</head>
	<body>
		<Header />
		<main
			data-mode="reading"
			data-indicator-tag={indicatorTag ? indicatorTag : null}
		>
			<slot />
		</main>
		<footer></footer>
	</body><script>
		//
		// Imports
		//

		import {
			getActiveAssessmentData,
			setState,
			subscribe,
		} from "src/stores/userDataStore";
		import { scrollIntoView } from "src/utilities/helpers";
		import { dialogControl } from "src/utilities/dialog";

		//
		// DOM Updates
		//

		let updateTheme = (data: UserData, changes) => {
			let triggerKeys = ["theme"];
			if (
				!changes.initiating &&
				!(
					changes.uiPreferences &&
					triggerKeys.some((val) =>
						changes.uiPreferences.includes(val),
					)
				)
			)
				return;

			let theme = data.uiPreferences.theme;
			if (theme !== "dark" && theme !== "light") return;

			console.log("Updating Theme (on html)");

			// Get the html root
			let html = document.documentElement;

			// Update the theme
			html.setAttribute("data-theme", theme);
		};

		let updateMode = (data: UserData, changes) => {
			let triggerKeys = ["mode"];
			if (
				!changes.initiating &&
				!(
					changes.uiState &&
					triggerKeys.some((val) => changes.uiState.includes(val))
				)
			)
				return;

			let mode = data.uiState.mode;
			if (mode !== "assessment" && mode !== "reading") mode = "reading";

			console.log("Updating Mode (on main)");

			// Get the main
			let main = document.querySelector("main");

			// Update the mode
			main.setAttribute("data-mode", mode);
		};

		let updateStatus = (data: UserData, changes) => {
			let triggerKeys = ["status"];
			if (
				!changes.initiating &&
				!(
					changes.assessments &&
					triggerKeys.some((val) => changes.assessments.includes(val))
				)
			)
				return;

			let assessment = getActiveAssessmentData();
			if (!assessment) return;

			console.log("Updating Status (on main)");

			let status = assessment.status;
			if (status !== "In Progress" && status !== "Complete")
				status = "In Progress";

			// Get the main
			let main = document.querySelector("main");

			// Update the status
			main.setAttribute(
				"data-status",
				status.split(" ").join("-").toLowerCase(),
			);
		};

		let updateAssessor = (data: UserData, changes) => {
			let triggerKeys = ["status"];
			if (
				!changes.initiating &&
				!(
					changes.assessments &&
					triggerKeys.some((val) => changes.assessments.includes(val))
				)
			)
				return;

			let assessment = getActiveAssessmentData();
			if (!assessment) return;

			console.log("Updating Assessor (on main)");

			// Get the main
			let main = document.querySelector("main");

			// Update the assessor
			if (
				!assessment.activeAssessor ||
				assessment.activeAssessor === undefined
			) {
				main.setAttribute("data-assessor", "false");
			} else {
				main.setAttribute("data-assessor", "true");
			}
		};

		//
		// Methods
		//

		let scrollToConsideration = (tag) => {
			let consideration = document.querySelector(`[value="${tag}"]`);

			if (!consideration) return;

			let accordion = consideration.closest(".accordion");
			let accordionBtn = accordion?.querySelector(
				".heading button",
			) as HTMLButtonElement;

			if (!accordion || !accordionBtn) return;

			if (accordionBtn.getAttribute("aria-expanded") === "true") return;

			accordionBtn.click();

			setTimeout(() => {
				scrollIntoView(accordion, { behavior: "smooth" });
			}, 50);
		};

		//
		// Inits
		//

		subscribe(updateTheme);
		subscribe(updateMode);
		subscribe(updateStatus);
		subscribe(updateAssessor);

		dialogControl.init();
		document.addEventListener("astro:before-swap", dialogControl.destroy);
		document.addEventListener("astro:after-swap", dialogControl.init);

		//
		// Event listeners
		//

		window.addEventListener("popstate", () => {
			// Handles hash changes on the active page

			let hash = window.location.hash;
			if (!hash) return;

			// If link was within a dialog, close it
			let activeDialog = document.querySelector(
				"dialog:open",
			) as HTMLDialogElement;
			if (activeDialog) activeDialog.close();

			if (hash.includes("consideration")) {
				let tag = hash
					.replace(/^#consideration-/, "")
					.replace(/-/g, ".");
				scrollToConsideration(tag);
			}
		});

		document.addEventListener("astro:page-load", () => {
			let currentPagePath = window.location.pathname;

			if (currentPagePath !== "/") {
				setState({
					lastVisitedPage: {
						title: document.querySelector("h1").textContent,
						path: window.location.pathname,
					},
				});
			}

			// Handles hash changes on a new page

			let hash = window.location.hash;

			if (hash.includes("consideration")) {
				let tag = hash
					.replace(/^#consideration-/, "")
					.replace(/-/g, ".");
				scrollToConsideration(tag);
			}

			let query = new URLSearchParams(window.location.search);
			let dialog = query.get("dialog");
			if (dialog) {
				let dialogId;
				if (dialog === "create-assessment")
					dialogId = "edit-assessment-properties-dialog";
				dialogControl.open({
					dialogId,
					context: "setup",
				});
			}
		});
	</script>
</html>
